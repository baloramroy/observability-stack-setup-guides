# Prometheus and Alertmanager Integration on Linux

## Objective

The objective of this SOP is to define the standardized procedure for **integrating Prometheus with Alertmanager** in a **Docker Compose–based or Binary based Linux environment**.
This ensures that alerts generated by Prometheus are reliably routed, grouped, and delivered by Alertmanager.

---

## Prerequisites

- **Prometheus** deployed and running via Docker Compose or Bianry.
- **Alertmanager** deployed and running via Docker Compose or Bianry.
- Both services connected to the **same Docker network** (example: `monitoring`) or if **binary** installation then make sure they can **reach each other through network**.
- **Shell access** (sudo/root) to edit **configuration files**.
- Basic understanding of Prometheus alerting rules.

---

## Architecture Overview

### Logical Alert Flow

```
Prometheus
   |
   | (alerts via HTTP)
   v
Alertmanager
   |
   | (routing & grouping)
   v
Notification Channel (Email / MS Teams / Slack / Webhook)
```

---

## Verify Network Configuration

1. Docker Network Requirement
2. Binary Installation Network Requirement

### ➡️`Docker Network` Requirement 

Both containers **must be on the same Docker network** so Prometheus can resolve Alertmanager by **container name** or still we can use the `ip address`.

- Check Network Exists

  ```bash
  docker network ls | grep monitoring
  ```

- Ensure Both Containers Are Connected

  ```bash
  docker inspect prometheus | grep monitoring
  docker inspect alertmanager | grep monitoring
  ```

  **Note:**
  If either container is missing from the network, update its `docker-compose.yml` and redeploy.

#

### ➡️`Binary Installation Network` Requirement

- Run `telnet` from prometheus to alertmanager if they are on **different** server
  ```bash
  telnet 192.168.0.124 9093
  ```
  Output: You will see **Connected** in the dispaly

- If they are installed on the **same server** then by default they can reach each other, so there is no need to check the **connectivity**.

---

## Update Prometheus Configuration

### Locate Prometheus Configuration File

Example path:

```
/home/observer/container/prometheus/prom_config/prometheus.yml
```

#

### Configure Alertmanager Target in Prometheus

- Edit `prometheus.yml` and add or update the **alerting** section (Docker Container):

  ```yaml
  alerting:
    alertmanagers:
      - static_configs:
          - targets:
              - alertmanager:9093
  ```

- For Binary installation we can use the server ip directly:\
  Edit `/etc/prometheus/promethus.yml`
  
  ```yaml
  alerting:
    alertmanagers:
      - static_configs:
          - targets:
              - 192.168.0.124:9093
  ```

**Important Notes:**

- `alertmanager` **must match the Alertmanager container name**
- Do **not** use **host IP** when containers share a Docker network
- Use **host IP** when its a **binary installation** not **docker container**
- Port **9093** is the default Alertmanager API port

---


## Reload or Restart Prometheus

### Reload Configuration

- If lifecycle reload is enabled:

  ```bash
  curl -X POST http://localhost:9090/-/reload
  ```

- Or Restart Prometheus Container

  ```bash
  docker compose restart prometheus
  ```

---

## Verify Prometheus → Alertmanager Connectivity

### Check Prometheus UI

- Open Prometheus UI:

  ```
  http://<prometheus_ip>:9090
  ```

- Navigate to:

  ```
  Status → Alertmanagers
  ```

- Expected Result:

  ```
  Alertmanager
    alertmanager:9093
  ```

---

## Validate Alert Flow

### Ensure Rule Files Are Loaded

- Check example section in `prometheus.yml` file:

  ```yaml
  rule_files:
    - "/etc/prometheus/alert-rules/*.yml"
  ```

### Force a Test Alert

- Temporarily create a test rule:

  ```yaml
  - alert: AlwaysFiringTest
    expr: vector(1)
    for: 10s
    labels:
      severity: warning
    annotations:
      summary: "Test alert"
      description: "This is a test alert to verify Alertmanager integration."
  ```

- Reload Prometheus and verify alert navigate to:

  ```
  Alerts
  ```

### Verify Alert in Alertmanager

- Access Alertmanager UI

  ```
  http://<alertmanager_ip>:9093
  ```

- Navigate to:

  ```
  Alerts
  ```

  **Expected Result:**

  - Alert visible
  - Correct labels and annotations
  - Routed to the configured receiver

---

## Troubleshooting

### Prometheus Cannot Reach Alertmanager

- Ensure both containers are on the **same Docker network**
- Verify container name resolution:

  ```bash
  docker exec -it prometheus ping alertmanager
  ```

#

### Alerts Visible in Prometheus but Not in Alertmanager

- Check `alerting.alertmanagers.targets`
- Verify Alertmanager is running and healthy
- Check Alertmanager logs:

  ```bash
  docker logs alertmanager
  ```

---

## Notes

- Prometheus sends alerts via **HTTP API**, not push notifications.
- Alertmanager handles:
  - Grouping
  - Deduplication
  - Silencing
  - Notification delivery

- Always test integration after:
  - Config changes
  - Container restarts
  - Network changes

---
