# Prometheus Binary Installation on Linux Using Tarball

## Objective
This SOP outlines the procedure for deploying **Prometheus** on a Linux system using its **binary** distribution. It includes instructions for configuring Prometheus as a **systemd** service, setting up **directories** and **data retention policies**.

---

## Download the Prometheus tarball (official release)

1. Navigate to the **[Prometheus Downloads page](https://prometheus.io/download/)** and download the latest **Linux AMD64 tarball**. 

    `Or`

2. **Download Binary package using command line:**

    **Syntax:**
    
    - Download using this **link** (replace `X.Y.Z` with the **version** you choose):
    
      ```bash
      sudo wget https://github.com/prometheus/prometheus/releases/download/vX.Y.Z/prometheus-X.Y.Z.linux-amd64.tar.gz
      ```
    
    **Example:**
    
    - If the server has **internet connection** then **download prometheus Tarball** using this command
    
      ```bash
      sudo wget https://github.com/prometheus/prometheus/releases/download/v3.7.3/prometheus-3.7.3.linux-amd64.tar.gz
      ```	
      > **Note:** This will download the file to the current working directory
    
    
    - If the server has **no internet**, then use **proxy to download prometheus tarball** using this command
    
      ```bash
      sudo wget \
      -e use_proxy=yes \
      -e http_proxy=http://proxy_ip:port \
      -e https_proxy=http://proxy_ip:port \
      https://github.com/prometheus/prometheus/releases/download/v3.7.3/prometheus-3.7.3.linux-amd64.tar.gz
      ```
      > **Note:** Replace the **proxy_ip:port** with real ip and port

      
**Extract and rename files:** 

- **Extract** the downloaded package
  ```bash
  sudo tar -xvf prometheus-3.7.3.linux-amd64.tar.gz
  ```
  
- Now **rename** the extracted file for making the future task easy
  ```bash
  mv prometheus-3.7.3.linux-amd64 prometheus
  ```

---

## PREPARE THE SYSTEM

**Ensure system packages are updated:**

 - Update and **upgrade** packages for Debian/Ubuntu user
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```
   
 - Update and **upgrade** packages for RHEL/CentOS/Fedora user
   ```bash
    sudo yum update -y
   ```
   
**Create a dedicated user and group:**

 - Create **Prometheus** user and Group
   ```bash    
   sudo useradd -M -s /bin/false prometheus
   ```   
	 - `-M, --no-create-home` –> Don not create home directory 	
	 - `-s, --shell` –> No login shell for the user

 - Check **user** and **group** created or not
   ```bash 
    id prometheus
   ```    
	**Output:** It will output the user and group id with their name.

**Create the necessary directories:**

 - Directories stores the prometheus **configuration** file

   ```bash
   sudo mkdir -p /etc/prometheus
   ```
   
 - Directories for stores **dynamic TSDB data** generated by prometheus
   services

   ```bash
   sudo mkdir -p /var/lib/prometheus
   ```
   
---

## Install the binaries and configuration files and set ownership

**Purpose:** Move **executables** to a **system path** and configs to `/etc`. Set proper **ownership**.

**Copy the binary files**

- From the prometheus downloaded folder copy prometheus binary file to bin folder:
    ```bash
    sudo cp prometheus/prometheus /usr/local/bin/
    ```

 - From the same directory copy the promtool to the bin directory:
   ```bash
    sudo cp prometheus/promtool /usr/local/bin/
   ```
    
   **Notes:** promtool is useful to validate configuration before starting Prometheus.


**Copy the configuration files**

- From the prometheus folder copy the yml file to the etc directory:
  ```bash
  sudo cp prometheus/prometheus.yml /etc/prometheus/
  ```

---

## Set Proper Ownership to the created directory

- **Set permissions for Prometheus binaries**
    
    ```bash
    sudo chmod 0755 /usr/local/bin/prometheus
    ```
    
    > **Output:** No output if successful (permissions set to rwxr-xr-x)

- **Set permissions for Promtool binary**
    ```bash
    sudo chmod 0755 /usr/local/bin/promtool
    ```
    
    > **Output:** No output if successful (permissions set to rwxr-xr-x)

- **Change ownership of Prometheus binary to prometheus user**
    ```bash
    sudo chown prometheus:prometheus /usr/local/bin/prometheus
    ```
    
    > **Output:** No output if successful (owner/group changed)

- **Change ownership of Promtool binary to prometheus user**
    ```bash
    sudo chown prometheus:prometheus /usr/local/bin/promtool
    ```
    
    > **Output:** No output if successful (owner/group changed)

- **Change ownership of Prometheus config directory**
    ```bash
    sudo chown -R prometheus:prometheus /etc/prometheus
    ```
    
    > **Output:** No output if successful (recursive ownership updated)

- **Change ownership of Prometheus data directory**
    ```bash
    sudo chown -R prometheus:prometheus /var/lib/prometheus
    ```
    
    > **Output:** No output if successful (recursive ownership updated)

---

## Open firewall ports (if applicable)

**Purpose:** Allow remote access to Prometheus web UI / scraping. Default port is 9090.

- **Allow this port in the system firewall**
    ```bash
    sudo firewall-cmd --add-port=9090/tcp --permanent
    ```

- **Reload firewall to load the configuration file**

  ```bash
  sudo firewall-cmd --reload
  ```

  > **Notes:** This permission is only needed if this service needs to be accessed by others remotely.

---

## Create a systemd unit file to run Prometheus as a service

**Purpose:** run Prometheus in background, restart on failure, and start at boot.

- Create and open this file:
    ```bash
    nano /etc/systemd/system/prometheus.service
    ```

- Paste the following content:

    ```
    [Unit]
    Description=Prometheus Monitoring
    Wants=network-online.target
    After=network-online.target
    
    [Service]
    User=prometheus
    Group=prometheus
    Type=simple
    ExecStart=/usr/local/bin/prometheus \
      --config.file=/etc/prometheus/prometheus.yml \
      --storage.tsdb.path=/var/lib/prometheus \
      --storage.tsdb.retention.time=30d \
      --web.console.templates=/etc/prometheus/consoles \
      --web.console.libraries=/etc/prometheus/console_libraries
    
    # Custom log location
    #StandardOutput=append:/var/log/prometheus/prometheus.log
    #StandardError=append:/var/log/prometheus/prometheus-error.log
    
    Restart=on-failure
    LimitNOFILE=65536
    
    [Install]
    WantedBy=multi-user.target
    ```

---

## Reload systemd and Start Prometheus

```bash
sudo systemctl daemon-reload
sudo systemctl enable prometheus
sudo systemctl start prometheus
sudo systemctl status prometheus
```

---

## Access Prometheus Web UI

- Open your browser and navigate to:
    ```
    http://<your-server-ip>:9090
    ```
- Use curl to check from the command line:
    ```bash
    curl http://<your-server-ip>:9090
    ```

---

## Access Prometheus Log 

Prometheus does not write logs, It simply prints logs to **STDOUT/STDERR**.  Since Prometheus runs as a **systemd service**, logs automatically go to **journalctl**.

**Access Journal Log**

```bash
sudo journalctl -u prometheus
sudo journalctl -u prometheus -f
sudo journalctl -u prometheus --since "10 min ago"
```

---

## Prometheus Logs in a File (Optional, Not Recommended)

You can manually redirect logs to a file inside the systemd service.

- Edit the systemd unit:
    ```
    sudo nano /etc/systemd/system/prometheus.service
    ```

- Add the below lines:
    ```
    StandardOutput=append:/var/log/prometheus/prometheus.log
    StandardError=append:/var/log/prometheus/prometheus-error.log
    ```

- Then create the directory:
    ```
    sudo mkdir -p /var/log/prometheus
    ```

- Then Change the Directory Permission:
    ```
    sudo chown prometheus:prometheus /var/log/prometheus
    ```

- Reload and restart services:
    ```
    sudo systemctl daemon-reload
    sudo systemctl restart prometheus
    ```

**But remember:**  

> This is optional and not the default behavior.
> Most admins prefer systemd journal because it’s cleaner.

---

## NOTES

 -   Default port: `9090`
 -   Configuration file: `/etc/prometheus/prometheus.yml`
 -   Binary path: `/usr/local/bin/prometheus`
 -   Data path: `/var/lib/prometheus`
 -   Service file: `/etc/systemd/system/prometheus.service`
 -   To view logs: `sudo journalctl -u prometheus -f`
 -   To view custom logs: `/var/log/prometheus`

---

